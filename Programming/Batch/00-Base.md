# Batch

Batch - язык используемый windows для bat файлов

# Начальная настройка консоли

Начальная настройка:

-   [Отключаем засирание консоли](#console---disable-log)
-   [Подключаем русские символы](#console---русские-символы)
-   [Меняем заголовок консоли](#console---tittle)
-   [Меняем цвет текста/фона консоли](#console---color)

# Console

## Вывод в консоль

Вывод в консоль:

-   [echo - выводим в консоль](#console---echo)
-   [echo - выводим пустую строку](#console---new-line)

Ввод в консоль:

-   [Считать значение переменной из консоли](#variable---прочитать-переменную-из-консоли)

Логика потоков в windows работает примерно как в Linux:

-   [Перенаправляем поток в файл](#stream---write)
-   [Перенаправляем поток в никуда](#stream---null)

## Жизненный цикл консоли

Управление жизненным циклом консоли:

-   [Pause - остановка работы до ввода символа](#console---pause)
-   [Exit - прекращение работы](#console---exit)

# Syntax

Базовые синтаксические конструкции

## Комментарии

Комментарии:

-   [Основной способ оставлять комментарии](#syntax---comment)
-   [Вспомогательный способ осталять комментарии](#syntax---comment2)

## Условия

Условия - классика, if/else:

-   [ERRORLEVEL - ошибка прошлой комманды](#syntax---errorlevel)
-   [if/else - пример](#syntax---condition)
-   [Операторы сравнения внутри условий](#syntax---операторы)

## Циклы

Цикл for - удинственный доступный, но из-за флагов превращается в комшарчик:

-   [Пройтись по элементам в списке](#for---for-in)
-   [Пройтись в циеле по range из чисел](#for---for-in-range)
-   [Пройтись по всем файлам в папке(и подпапках)](#for---пройтись-по-всем-файлам-в-папке)
-   [Пройтись по файлу/тексту/резльтату-комманды](#for---пройтись-по-фалутекстурезультату-команды)

## Goto

Goto - по сути прыжок к метке, но можно и создавать что-то вроде методов:

-   [Пример бесконечного цикла из метки и goto](#goto---бесконечный-цикл)
-   [Пример метода](#goto---метод)

## Строки

-   [Замена подстроки в строке](#string---замена-подстроки-в-строке)
-   [Извлекаем начало/середину/конец строки](#string---извлекаем-началосерединуконец-строки)

## String - Извлекаем начало/середину/конец строки

Извлекаем начало/середину/конец строки:

-   ~-12 - извлекаем последние 12 символов
-   ~3,10 - извлекаем 10 символов начиная с 4 символа
-   ~0,6 - извлекаем первые 6 символов

```bat
set str=How it can be thruth?
set str=%str:~-12%
:: => n be thruth?
set str=%str:~3,10%
:: =>  it can be
set str=%str:~0,6%
:: => How it
```

## String - Замена подстроки в строке

Замена подстроки в строке:

```bat
set str=если то, то не то
set res=%str:то=иногда%
:: => если иногда, иногда не иногда
```

Замена подстроки в строке с использованием переменных:

```bat
set str=it is string num 1
set var_1=is
set var_2=grow grow
call set res=%%str:%var_1%=%var_2%%%%
:: => it grow grow string num 1
```

## Переменные

Переменные внутри bat скрипта:

-   [Создание и использование переменной](#variable---создаем-переменную)
-   [Использование переменной как макрос](#variable---используем-переменные-как-макрос)
-   [Считать значение переменной из консоли](#variable---прочитать-переменную-из-консоли)

Записать/считать переменные из файла:

-   [Записываем список всех доступных переменных в файл](#variable---записать-переменные)
-   [Считываем переменные из файла](#variable---считать-переменные)

Задать Environment variable:

-   [Задаем environment переменные в windows](#variable---environment-variable)
-   [Добавляем значения в PATH для Environment Variable, только на время работы bat](#variable---environment-variable-только-для-этой-сессии)

# Примеры

## For - For In

For In - пройтись по элементам списка в цикле:

```batch
for %%i in (a b c) do (
    echo %%i
)

:: => a
:: => b
:: => c
```

## For - For In Range

For In - пройтись по элементам списка в цикле:

-   /l - флаг того, что проходимся по элементам в цикле
-   (5,-2,1) - от 5 с шагом -3 до -2

```batch
for /l %%i in (5,-3,-2) do (
    echo %%i
)

:: => 5
:: => 2
:: => -1
```

## For - Пройтись по всем файлам в папке

Проходится по всем файлам в папке и проверяет имена на соответствие шаблону:

-   /R - флаг того, что проходимся по файлам из папки в цикле
-   C:\rep\etalon - папка в которой проходимся по файлам
-   FiltredDataDTO.\* OnChangeServerCode.\* - два шаблона по которым будет происходить поиск

```bat
for /R C:\rep\etalon %%G in (FiltredDataDTO.* OnChangeServerCode.*) do (
    echo %%G
)
```

## For - Пройтись по фалу/тексту/результату-команды

Проходимся по файлу/тексту/результату-команды:

-   /F - флаг того, что проходимся по файлу/тексту
-   "eol=; tokens=1-3 delims=,|"
    -   eol=; - если строка начинается с ; то мы ее игнорируем
    -   delims=,| - делит строку на подстроки по символу , и по |
    -   tokens=1-3; - берет 1, 2 и 3 найденные подстроки
        -   tokens=\*; - берет все подстроки
        -   tokens=1,2,5; - берет 1, 2 и 5 подстроки
        -   tokens=1-3; - берет с 1 по 3 найденные подстроки
-   %%i %%j %%k - кладет найденные подстроки в переменные, в алфавитном порядке
    -   начинает с %%i, т.к. задана в цикле
-   (./file.txt ./file2.txt) - файлы через пробел, так же может быть:
    -   (`dir`) - результат работы команды
    -   ("text is here") - просто текст

```bat
for /F "eol=; tokens=1-3 delims=,|" %%i in (./file.txt ./file2.txt) do (
    echo %%i
    echo %%j
    echo %%k
)
```

## Variable - Записать переменные

Список всех доступных переменных можно записать в файл:

```bat
set > env-var
```

## Variable - Считать переменные

Получить переменные из файла:

-   env-var.txt - файл из которого вытаскиваем переменные

```bat
for /f "delims== tokens=1,2" %%G in (env-var.txt) do set %%G=%%H
```

Пример файла env-var.txt:

-   использование равно внутри переменной, заканчиавает переменную

```txt
PARAM1=value1 it's value
PARAM2=value2
```

## Variable - Создаем переменную

Создаем переменную переменную внутри bat скрипта:

```bat
set test="\wamp\bin\php\php5.4.16"
echo %test%
:: => "\wamp\bin\php\php5.4.16"

set test2=a=2+2
echo %test2%
:: => a=2+2

set /a test3=2+2
echo %test3%
:: => 4
```

## Variable - Используем переменные как макрос

Переменные в batch, ближе к макросам, и по сути значение переменной подставляется прямо в скрипт:

-   в примере, произойдет создание метки в runtime
    -   если var_project=1
    -   если var_todo=2
    -   имя вызванной метки будет run_1_2
-   goto run*%var_project%*%var_todo%
    -   goto - перемеходим к метке с именем
    -   run*%var_project%*%var_todo% - имя метки, которое собирется на ходу
        -   %var_project% - сюда подставится переменная var_project
        -   %var_todo% - сюда подставится переменная var_todo

```bat
goto run_%var_project%_%var_todo%
```

## Variable - Прочитать переменную из консоли

Прочитать переменную из консоли:

-   /p - флаг запроса значения
-   a - имя переменной
-   Enter str - выводимая строка

```bat
set /p a=Enter str
```

## Variable - Environment Variable

[Environment Virable](../../Windows/02-Base.md#environment-variable) - можно задать через консоль:

-   Задаем User Variable

```bat
setx VAR_NAME value
```

-   Задаем System Variable:

```bat
setx VAR_NAME value /m
```

## Variable - Environment Variable только для этой сессии

Добавляем значения в PATH для Environment Variable, только на время работы bat:

-   setlocal - начало локального задания переменных в PATH
-   endlocal - конец локального задания переменных в PATH

```bat
setlocal
SET PATH=%PATH%;C:\Program Files\BellSoft\LibericaJDK-17\bin\;
endlocal
```

## Syntax - Errorlevel

Возможно предыдущая команда закончила работать с ошибкой, тогда обрабатываем по другому:

-   например find может бросить ошибку если ничего не нашел

```bat
if not %ERRORLEVEL% equ 1 (
    echo ok
) else (
    echo error
)
```

То же самое, но написано немного по другому:

```bat
if "%ERRORLEVEL%"=="0" (
    echo ok
) else (
    echo error
)
```

## Syntax - Condition

Пример if:

```bat
if not errorlevel equ 1 goto end
```

Пример if/else:

```bat
if "%ERRORLEVEL%"=="0" (
    echo STATE: %exe_name% запущен
) else (
    call :runexe_nginx
)
```

## Syntax - Операторы

Операторы:

| Оператор | Описание         |
| :------- | :--------------- |
| EQU      | равно            |
| NEQ      | не равно         |
| LSS      | меньше           |
| LEQ      | меньше или равно |
| GTR      | больше           |
| GEQ      | больше или равно |

Пример использования:

```bat
if not errorlevel equ 1 goto end
```

## Syntax - Comment

Comment - оставляем комментарий:

-   основной способ оставлять комментрии
-   по сути вызваем метод, который ничего не делает

```bat
rem комментарий тут, что ты ему сделаешь?
@REM комментарий тут, что ты ему сделаешь?
```

## Syntax - Comment#2

Comment - оставляем комментарий:

-   почему-то его не используют

```bat
:: echo 0) Выход
```

## Goto - Метод

Метод - goto можно использовать как метод и еще какие-то значения прокинуть:

-   call :method "МЕТОД ВЫЗВАН!!!"
    -   :method - метка которую вызваем
    -   "МЕТОД ВЫЗВАН!!!" - значение которое передаем, можно передать несколько
-   echo "%~1" - выводим первое переданное в метод значение
-   goto :eof - вернет обратно в точку вызова

```bat
call :method "МЕТОД ВЫЗВАН!!!"
exit

:method
echo "%~1"
goto :eof
```

## Goto - Бесконечный цикл

Делаем бесконечный цикл:

-   :m - метка
-   goto m - переходим к метке m

```bat
:m
goto m
```

## Console - Pause

Pause - пауза, остановка работы программы до введения любого символа:

```bat
pause
```

## Console - Exit

Exit - прекращение работы batch файла:

```bat
exit
```

## Console - Color

Color - меняет цвет текста/консоли:

-   9b - шестнадцатиричное значение, указывающая цвет
    -   первый символ - фон
    -   вторый символ - текст

```bat
color 9b
```

<img src="./source/03-Host.png" style="display: block; height: 300px; margin: auto;"/>

## Console - Tittle

Поменять заголок окна:

```bat
title Новый заголовок
```

## Stream - Write

Запись(перезапись) в файл:

```bat
echo Test > file.txt
```

Запись(добавление) в файл:

```bat
echo Test2 >> file.txt
```

## Stream - Null

## Console - echo

echo - команда вывода в консоль:

```bat
echo 0) Выход
:: => 0) Выход
```

## Console - New line

New line - для вывода пустой строки используй:

```bat
echo[
echo 0) Выход
:: =>
:: => 0) Выход
```

## Console - Disable log

Disable log - отключаем логи(в каком-то смсле), любая команда срет в консоль, чтобы этого не происходило используй в начале:

```bat
@echo off
```

## Console - Русские символы

Русские символы - как-то не работает batch с русскимим символами без вот этой штуки:

```bat
chcp 65001
```
